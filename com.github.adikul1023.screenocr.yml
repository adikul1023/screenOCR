app-id: com.github.adikul1023.screenocr
runtime: org.freedesktop.Platform
runtime-version: '24.08'
sdk: org.freedesktop.Sdk

command: screenocr

finish-args:
  # Network access for auto-installing dependencies
  - --share=network
  
  # Display
  - --socket=wayland
  - --socket=x11
  - --share=ipc
  
  # Input devices for hotkey support (required for keyboard library)
  - --device=all
  - --env=XKB_CONFIG_ROOT=/usr/share/X11/xkb
  
  # D-Bus for system integration
  - --socket=session-bus
  - --socket=system-bus
  
  # XDG Portal for screenshot (D-Bus access required)
  - --talk-name=org.freedesktop.portal.Desktop
  - --talk-name=org.freedesktop.ScreenSaver
  
  # Filesystem access
  - --filesystem=xdg-cache
  - --filesystem=/tmp:rw
  - --env=HOME=/home/user

modules:
  - name: screenocr
    buildsystem: simple
    build-commands:
      - mkdir -p /app/bin /app/lib/screenocr /app/share/applications /app/share/icons/hicolor/256x256/apps
      
      # Copy Python modules
      - cp main.py ocr_engine.py portal.py overlay.py utils.py hotkey_daemon.py setup_environment.py /app/lib/screenocr/
      
      # Create launcher wrapper
      - |
        cat > /app/bin/screenocr << 'LAUNCHER'
        #!/bin/bash
        export PYTHONPATH=/app/lib/screenocr:$PYTHONPATH
        
        # Ensure pip is available for our auto-setup system
        if ! python3 -m pip --version &>/dev/null; then
            echo "[Flatpak] Installing pip..."
            python3 -m ensurepip --user --default-pip 2>/dev/null || true
        fi
        
        # Run with proper environment (setup_environment.py will auto-install deps)
        exec python3 /app/lib/screenocr/main.py "$@"
        LAUNCHER
        chmod +x /app/bin/screenocr
      
      # Desktop entry
      - |
        cat > /app/share/applications/com.github.adikul1023.screenocr.desktop << 'DESKTOP'
        [Desktop Entry]
        Version=1.0
        Type=Application
        Name=ScreenOCR
        Comment=Hotkey-triggered OCR utility for Linux
        Exec=screenocr trigger
        Icon=com.github.adikul1023.screenocr
        Categories=Utility;Office;TextTools;
        Keywords=ocr;text;extraction;screenshot;
        Terminal=false
        X-GNOME-Autostart-enabled=false
        DESKTOP
      
      # Create icon (use existing PNG)
      - cp screencapture.png /app/share/icons/hicolor/256x256/apps/com.github.adikul1023.screenocr.png
    
    sources:
      - type: dir
        path: .

cleanup:
  - /include
  - /lib/pkgconfig
  - /lib/*.la
  - /lib/*.a
  - /share/doc
  - /share/man
  - /share/info
