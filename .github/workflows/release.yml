name: Build and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install PyInstaller
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-dev libssl-dev libffi-dev libxkbcommon0 libfuse2
    
    - name: Build AppImage
      run: |
        mkdir -p build/ScreenOCR.AppDir
        cp main.py ocr_engine.py portal.py overlay.py utils.py hotkey_daemon.py build/ScreenOCR.AppDir/
        cp screenocr.desktop build/ScreenOCR.AppDir/
        
        # Create AppRun
        cat > build/ScreenOCR.AppDir/AppRun << 'APPRUN'
        #!/bin/bash
        APPDIR="$(dirname "$(readlink -f "${0}")")"
        VENV_PYTHON="/home/ak/Documents/OCR/venv-sys/bin/python3"
        if [ -f "$VENV_PYTHON" ]; then
            PYTHON="$VENV_PYTHON"
        else
            PYTHON=$(which python3)
        fi
        export PYTHONPATH="${APPDIR}:${PYTHONPATH}"
        cd "${APPDIR}"
        exec $PYTHON "${APPDIR}/main.py" "$@"
        APPRUN
        chmod +x build/ScreenOCR.AppDir/AppRun
        
        # Build AppImage (using existing icon: screencapture.png)
        wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
        chmod +x appimagetool-x86_64.AppImage
        ARCH=x86_64 ./appimagetool-x86_64.AppImage --no-appstream build/ScreenOCR.AppDir ScreenOCR.AppImage
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ScreenOCR.AppImage
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  flatpak:
    runs-on: ubuntu-latest
    container:
      image: bilelmoussaoui/flatpak-github-actions:latest
      options: --privileged

    steps:
    - uses: actions/checkout@v4
    
    - name: Install Flatpak Runtime
      run: |
        flatpak install --noninteractive --assumeyes flathub org.freedesktop.Platform//24.08
        flatpak install --noninteractive --assumeyes flathub org.freedesktop.Sdk//24.08
    
    - name: Build Flatpak
      run: |
        flatpak-builder --force-clean build-flatpak \
          com.github.adikul1023.screenocr.yml \
          --repo=repo
    
    - name: Bundle Flatpak
      run: |
        flatpak build-bundle repo screenocr.flatpak \
          com.github.adikul1023.screenocr
    
    - name: Upload to Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          screenocr.flatpak
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
